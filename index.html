<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Wydatki miesiƒôczne</title>

<!-- Ikony / manifest PWA -->
<link rel="icon" href="favicon.ico">
<link rel="icon" sizes="192x192" href="icon-192.png">
<link rel="icon" sizes="512x512" href="icon-512.png">
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="manifest" href="manifest.json">

<style>
  :root{
    --card:#fff; --border:#e6e8f0; --text:#0f172a; --muted:#64748b;
    --btn:#0ea5e9; --btn-ok:#16a34a; --shadow:0 6px 20px rgba(15,23,42,.06);
    --fuel-bg:#eef6ff; --other-bg:#f5f7fa;
  }
  body{ margin:0; font-family:system-ui,"Segoe UI",Roboto,sans-serif; color:var(--text);
        background:linear-gradient(180deg,#f7f9ff 0%,#eef2ff 100%); }
  .wrap{ max-width:980px; margin:26px auto; padding:0 16px; }
  .toolbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    background:var(--card); border:1px solid var(--border); border-radius:14px; padding:10px 12px; box-shadow:var(--shadow); margin-bottom:14px;}
  .toolbar .spacer{ flex:1; }
  .btn{ padding:8px 12px; border:1px solid var(--border); border-radius:10px; background:#fff; cursor:pointer; transition:.15s;
        font-size:14px; }
  .btn:hover{ transform:translateY(-1px); box-shadow:0 6px 16px rgba(0,0,0,.08); }
  .btn.primary{ background:var(--btn); border-color:var(--btn); color:#fff; }
  .btn.ok{ background:var(--btn-ok); border-color:var(--btn-ok); color:#fff; }
  .controls{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px; box-shadow:var(--shadow); margin-bottom:14px; }
  .controls label{ margin-right:8px; display:inline-flex; align-items:center; gap:6px; }
  .controls input,.controls select{ padding:6px 8px; border:1px solid var(--border); border-radius:10px; font-size:14px; }
  .section{ background:var(--card); border:1px solid var(--border); border-radius:16px; padding:14px; margin-bottom:16px; box-shadow:var(--shadow); }
  .section.fuel{ background:var(--fuel-bg); }
  .section.other{ background:var(--other-bg); }
  .cards{ display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:12px; }
  .card{ background:#fff; border:1px solid var(--border); border-radius:12px; padding:10px; display:flex; flex-direction:column; gap:8px; }
  .row{ display:flex; flex-direction:column; gap:6px; }
  .row label{ font-size:12px; color:var(--muted); }
  .row input,.row select{ padding:6px 8px; border:1px solid var(--border); border-radius:8px; font-size:14px; }
  .card .actions{ display:flex; justify-content:space-between; gap:8px; }
  .muted{ color:var(--muted); }
  #footerApp{ margin-top:8px; text-align:center; font-size:12px; color:var(--muted); }

  /* Tabela do PDF (i podglƒÖdu) ‚Äì klasyczna */
  table.report{ width:100%; border-collapse:collapse; background:#fff; }
  table.report th, table.report td{ border:1px solid #ddd; padding:6px 8px; font-size:13px; }
  table.report th{ background:#f3f4f6; text-align:center; font-weight:600; }

  /* Wydruk PDF */
  @media print{
    body{ font-family:"Times New Roman", Times, serif; font-size:11px; background:#fff; }
    .no-print{ display:none !important; }
    table.report th, table.report td{ border:1px solid #000; padding:3px 5px; font-size:10px; background:#fff !important; }
    #pdfFooter{ display:block; text-align:center; font-size:10px; margin-top:6px; }
    @page{ size:A4 portrait; margin:8mm; }
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body>
<div class="wrap">
  <div class="toolbar no-print">
    <h1 style="margin:0;font-size:18px">Wydatki miesiƒôczne</h1>
    <div class="spacer"></div>
    <button class="btn primary" id="btnPdf">Eksportuj do PDF</button>
    <button class="btn ok" id="btnExcel">Eksport do Excela</button>
    <button class="btn" id="btnClear">Wyczy≈õƒá dane</button>
  </div>

  <div class="controls no-print">
    <label>Imiƒô i nazwisko: <input type="text" id="name" placeholder="np. Jan Kowalski"></label>
    <label>Rok: <input type="number" id="year" style="width:100px"></label>
    <label>MiesiƒÖc:
      <select id="month">
        <option value="0">Stycze≈Ñ</option><option value="1">Luty</option><option value="2">Marzec</option>
        <option value="3">Kwiecie≈Ñ</option><option value="4">Maj</option><option value="5">Czerwiec</option>
        <option value="6">Lipiec</option><option value="7">Sierpie≈Ñ</option><option value="8">Wrzesie≈Ñ</option>
        <option value="9">Pa≈∫dziernik</option><option value="10">Listopad</option><option value="11">Grudzie≈Ñ</option>
      </select>
    </label>
  </div>

  <div class="section fuel no-print">
    <div style="display:flex;gap:10px;align-items:center;margin-bottom:8px;">
      <h3 style="margin:0;flex:1;">‚õΩ Tankowania</h3>
      <button class="btn" id="addFuel">‚ûï Dodaj tankowanie</button>
    </div>
    <div id="fuelCards" class="cards"></div>
  </div>

  <div class="section other no-print">
    <div style="display:flex;gap:10px;align-items:center;margin-bottom:8px;">
      <h3 style="margin:0;flex:1;">üßæ Inne wydatki</h3>
      <button class="btn" id="addOther">‚ûï Dodaj wydatek</button>
    </div>
    <div id="otherCards" class="cards"></div>
  </div>

  <!-- Nag≈Ç√≥wek + podglƒÖd tabeli (te≈º druk) -->
  <div class="section">
    <h2 style="text-align:center;margin:6px 0;">Podsumowanie wydatk√≥w ‚Äì <span id="headerMonth"></span> <span id="headerYear"></span></h2>
    <div style="text-align:center; font-size:12px; color:#64748b;">Imiƒô i nazwisko: <span id="headerName">............................................</span></div>

    <table class="report" id="reportTable" style="margin-top:10px;">
      <thead>
        <tr>
          <th style="width:60px">Dzie≈Ñ</th>
          <th>Miejsce tankowania</th>
          <th style="width:90px">Litry</th>
          <th style="width:120px">Kwota tankowania</th>
          <th>Inne wydatki</th>
          <th style="width:120px">Kwota</th>
        </tr>
      </thead>
      <tbody id="reportBody"></tbody>
    </table>
  </div>

  <div id="footerApp" class="no-print">Tw√≥rcy: ≈Åukasz Stasinski &amp; ChatGPT ‚Ä¢ <span id="genDate"></span></div>
  <div id="pdfFooter" style="display:none;">LS &amp; GPT</div>
</div>

<script>
  // ========= STAN + PAMIƒòƒÜ =========
  const LS_KEY = "wydatki_monthly_v3";
  const state = {
    name: "", year: new Date().getFullYear(), month: new Date().getMonth(),
    fuelByDay: {},           // { [day]: {place, liters, fuelAmount} }  (max 1 tankowanie / dzie≈Ñ)
    others: []               // [{id, day, name, amount}]
  };
  let uid = 1;

  function save(){ localStorage.setItem(LS_KEY, JSON.stringify({...state, _uid: uid})); }
  function load(){
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return;
    try{
      const parsed = JSON.parse(raw);
      state.name = parsed.name||state.name;
      state.year = parsed.year||state.year;
      state.month = (parsed.month ?? state.month);
      state.fuelByDay = parsed.fuelByDay || {};
      state.others = Array.isArray(parsed.others) ? parsed.others : [];
      uid = parsed._uid || 1;
    }catch{}
  }

  // ========= ELEMENTY =========
  const elName = document.getElementById('name');
  const elYear = document.getElementById('year');
  const elMonth = document.getElementById('month');
  const fuelWrap = document.getElementById('fuelCards');
  const otherWrap = document.getElementById('otherCards');

  const DAY_OPTIONS = Array.from({length:31},(_,i)=>`<option value="${i+1}">${i+1}</option>`).join("");

  // ========= RENDER: NAG≈Å√ìWEK + PODGLƒÑD TABELI =========
  function renderHeader(){
    const months=["stycze≈Ñ","luty","marzec","kwiecie≈Ñ","maj","czerwiec","lipiec","sierpie≈Ñ","wrzesie≈Ñ","pa≈∫dziernik","listopad","grudzie≈Ñ"];
    document.getElementById('headerMonth').textContent = months[state.month];
    document.getElementById('headerYear').textContent = state.year;
    document.getElementById('headerName').textContent = state.name || "............................................";
  }

  function buildCombinedRows(){
    // Zbierz dni, w kt√≥rych cokolwiek jest
    const daySet = new Set();
    Object.keys(state.fuelByDay).forEach(d=>{
      const f = state.fuelByDay[d];
      if((f?.place?.trim())||(f?.liters?.trim())||(f?.fuelAmount?.trim())) daySet.add(Number(d));
    });
    state.others.forEach(o=>{ if(o.day && (o.name?.trim() || o.amount?.trim())) daySet.add(Number(o.day)); });
    const days = Array.from(daySet).sort((a,b)=>a-b);

    const rows = [];
    days.forEach(day=>{
      const f = state.fuelByDay[day] || {};
      const validFuel = (f.place?.trim() || f.liters?.trim() || f.fuelAmount?.trim());
      const others = state.others
        .filter(o=>Number(o.day)===Number(day) && (o.name?.trim() || o.amount?.trim()))
        .sort((a,b)=>(a.id-b.id));

      if(others.length === 0){
        // tylko tankowanie (lub puste, ale dzie≈Ñ zarejestrowany)
        if(validFuel){
          rows.push([day, f.place||"", f.liters||"", f.fuelAmount||"", "", ""]);
        }
      } else {
        // sƒÖ inne wydatki
        // pierwszy ≈ÇƒÖczymy z tankowaniem
        const first = others[0];
        rows.push([
          day,
          validFuel ? (f.place||"") : "",
          validFuel ? (f.liters||"") : "",
          validFuel ? (f.fuelAmount||"") : "",
          first.name||"",
          first.amount||""
        ]);
        // kolejne wydatki jako oddzielne linie
        for(let i=1;i<others.length;i++){
          const o = others[i];
          rows.push([day, "", "", "", o.name||"", o.amount||""]);
        }
      }
    });
    return rows;
  }

  function renderReportTable(){
    const tbody = document.getElementById('reportBody');
    tbody.innerHTML = "";
    const rows = buildCombinedRows();
    if(rows.length===0){
      tbody.innerHTML = `<tr><td colspan="6" class="muted" style="text-align:center">Brak wpis√≥w</td></tr>`;
      return;
    }
    rows.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td style="text-align:center">${r[0]}</td>
        <td>${r[1]}</td>
        <td style="text-align:right">${r[2]}</td>
        <td style="text-align:right">${r[3]}</td>
        <td>${r[4]}</td>
        <td style="text-align:right">${r[5]}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  // ========= RENDER: KARTY (INTERFEJS) =========
  function renderFuel(){
    fuelWrap.innerHTML = "";
    // poka≈º tylko dni, dla kt√≥rych co≈õ jest albo utworzone tankowanie
    const days = Object.keys(state.fuelByDay)
      .map(Number)
      .filter(d=>{
        const f=state.fuelByDay[d];
        return f && (f.place?.trim() || f.liters?.trim() || f.fuelAmount?.trim() || f._created);
      })
      .sort((a,b)=>a-b);

    days.forEach(day=>{
      const f = state.fuelByDay[day] || {};
      const card = document.createElement('div');
      card.className = "card";
      card.innerHTML = `
        <div class="row">
          <label>Dzie≈Ñ</label>
          <select data-kind="fuel-day" data-day="${day}">
            <option value=""></option>${DAY_OPTIONS}
          </select>
        </div>
        <div class="row">
          <label>Miejsce tankowania</label>
          <input type="text" data-kind="fuel-field" data-field="place" data-day="${day}" value="${f.place??""}" placeholder="np. Orlen Wolsztyn">
        </div>
        <div class="row">
          <label>Litry</label>
          <input type="text" data-kind="fuel-field" data-field="liters" data-day="${day}" value="${f.liters??""}" placeholder="np. 35,5">
        </div>
        <div class="row">
          <label>Kwota tankowania (PLN)</label>
          <input type="text" data-kind="fuel-field" data-field="fuelAmount" data-day="${day}" value="${f.fuelAmount??""}" placeholder="np. 250,00">
        </div>
        <div class="actions">
          <button class="btn" data-kind="fuel-delete" data-day="${day}">üóë Usu≈Ñ tankowanie</button>
        </div>
      `;
      fuelWrap.appendChild(card);
      // ustal warto≈õƒá select po dodaniu do DOM
      card.querySelector('select').value = String(day);
    });

    if(days.length===0){
      fuelWrap.innerHTML = `<div class="muted" style="text-align:center">Brak wpis√≥w ‚Äì kliknij ‚ÄûDodaj tankowanie‚Äù.</div>`;
    }
  }

  function renderOthers(){
    otherWrap.innerHTML = "";
    const items = [...state.others].sort((a,b)=>{
      if((a.day||0)!==(b.day||0)) return (a.day||0)-(b.day||0);
      return a.id-b.id;
    });
    if(items.length===0){
      otherWrap.innerHTML = `<div class="muted" style="text-align:center">Brak wpis√≥w ‚Äì kliknij ‚ÄûDodaj wydatek‚Äù.</div>`;
      return;
    }
    items.forEach(item=>{
      const card = document.createElement('div');
      card.className = "card";
      card.innerHTML = `
        <div class="row">
          <label>Dzie≈Ñ</label>
          <select data-kind="other-day" data-id="${item.id}">
            <option value=""></option>${DAY_OPTIONS}
          </select>
        </div>
        <div class="row">
          <label>Inny wydatek</label>
          <input type="text" data-kind="other-field" data-field="name" data-id="${item.id}" value="${item.name??""}" placeholder="np. Myjnia">
        </div>
        <div class="row">
          <label>Kwota (PLN)</label>
          <input type="text" data-kind="other-field" data-field="amount" data-id="${item.id}" value="${item.amount??""}" placeholder="np. 25,00">
        </div>
        <div class="actions">
          <button class="btn" data-kind="other-delete" data-id="${item.id}">üóë Usu≈Ñ wydatek</button>
        </div>
      `;
      otherWrap.appendChild(card);
      card.querySelector('select').value = item.day ?? "";
    });
  }

  function renderAll(){
    elName.value = state.name;
    elYear.value = state.year;
    elMonth.value = state.month;
    renderHeader();
    renderFuel();
    renderOthers();
    renderReportTable();
  }

  // ========= ZDARZENIA (BEZ PRZE-RENDERU NA LITERƒò) =========
  document.getElementById('addFuel').addEventListener('click', ()=>{
    // Tworzymy nowy wpis tankowania z domy≈õlnym dniem (pusty) ‚Äì poka≈ºe siƒô jako karta
    // Dla rozr√≥≈ºnienia tworzymy chwilowy day=1 i pozwalamy zmieniƒá, ale lepiej zrobiƒá bufor:
    // u≈ºyjemy najni≈ºszego wolnego dnia 1..31, kt√≥ry nie ma jeszcze tankowania
    let newDay = "";
    for(let d=1; d<=31; d++){ if(!state.fuelByDay[d]) { newDay = d; break; } }
    if(newDay===""){ newDay=31; } // awaryjnie
    state.fuelByDay[newDay] = { place:"", liters:"", fuelAmount:"", _created:true };
    save(); renderFuel(); renderReportTable();
  });

  document.getElementById('addOther').addEventListener('click', ()=>{
    state.others.push({ id: uid++, day:"", name:"", amount:"" });
    save(); renderOthers(); renderReportTable();
  });

  // Zmiany w polach TANKOWANIA
  document.addEventListener('input', (e)=>{
    const t = e.target;
    const kind = t.dataset.kind;

    if(kind === 'fuel-field'){
      const day = t.dataset.day;
      const field = t.dataset.field;
      if(!state.fuelByDay[day]) state.fuelByDay[day] = {place:"",liters:"",fuelAmount:""};
      state.fuelByDay[day][field] = t.value;
      save(); // bez renderu ‚Äì nie tracimy fokusa
      renderReportTable(); // podglƒÖd tabeli
    }
    if(kind === 'other-field'){
      const id = Number(t.dataset.id);
      const field = t.dataset.field;
      const idx = state.others.findIndex(x=>x.id===id);
      if(idx>=0){
        state.others[idx][field] = t.value;
        save();
        renderReportTable();
      }
    }
  });

  // Zmiana dnia (select) ‚Äì mo≈ºna od≈õwie≈ºyƒá sekcjƒô, ≈ºeby siƒô posortowa≈Ço
  document.addEventListener('change', (e)=>{
    const t = e.target;
    const kind = t.dataset.kind;

    if(kind === 'fuel-day'){
      const oldDay = Number(t.dataset.day);
      const newDay = t.value==="" ? "" : Number(t.value);
      const data = state.fuelByDay[oldDay];
      if(newDay==="" ){ // usuwamy przypisanie dnia
        delete state.fuelByDay[oldDay];
      }else{
        delete state.fuelByDay[oldDay];
        state.fuelByDay[newDay] = data || {place:"",liters:"",fuelAmount:""};
      }
      save(); renderFuel(); renderReportTable();
    }

    if(kind === 'other-day'){
      const id = Number(t.dataset.id);
      const idx = state.others.findIndex(x=>x.id===id);
      if(idx>=0){
        state.others[idx].day = t.value==="" ? "" : Number(t.value);
        save(); renderOthers(); renderReportTable();
      }
    }
  });

  // Usuwanie wpis√≥w
  document.addEventListener('click', (e)=>{
    const t = e.target;
    if(t.dataset.kind === 'fuel-delete'){
      const day = Number(t.dataset.day);
      delete state.fuelByDay[day];
      save(); renderFuel(); renderReportTable();
    }
    if(t.dataset.kind === 'other-delete'){
      const id = Number(t.dataset.id);
      const idx = state.others.findIndex(x=>x.id===id);
      if(idx>=0) state.others.splice(idx,1);
      save(); renderOthers(); renderReportTable();
    }
  });

  // G≈Ç√≥wny nag≈Ç√≥wek
  elName.addEventListener('input', ()=>{ state.name = elName.value; save(); renderHeader(); });
  elYear.addEventListener('input', ()=>{ state.year = parseInt(elYear.value,10) || new Date().getFullYear(); save(); renderHeader(); });
  elMonth.addEventListener('input', ()=>{ state.month = parseInt(elMonth.value,10); save(); renderHeader(); });

  // PDF (druk) ‚Äì tabela ju≈º jest na stronie, tylko drukujemy
  document.getElementById('btnPdf').addEventListener('click', ()=>{
    renderReportTable();
    window.print();
  });

  // Excel ‚Äì jeden arkusz, ta sama logika ≈ÇƒÖczenia
  document.getElementById('btnExcel').addEventListener('click', ()=>{
    const rows = [["Dzie≈Ñ","Miejsce tankowania","Litry","Kwota tankowania","Inne wydatki","Kwota"]];
    const combined = buildCombinedRows();
    combined.forEach(r=>rows.push(r));
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(rows), "Wydatki");
    const m = String(state.month+1).padStart(2,'0');
    XLSX.writeFile(wb, `Wydatki_${state.year}_${m}.xlsx`);
  });

  // Czyszczenie
  document.getElementById('btnClear').addEventListener('click', ()=>{
    if(confirm("Czy na pewno chcesz usunƒÖƒá wszystkie zapisane dane?")){
      localStorage.removeItem(LS_KEY);
      state.name=""; state.year=new Date().getFullYear(); state.month=new Date().getMonth();
      state.fuelByDay={}; state.others=[]; uid=1;
      renderAll();
    }
  });

  // Start
  (function(){
    load();
    elName.value = state.name;
    elYear.value = state.year;
    elMonth.value = state.month;
    const d=new Date();
    document.getElementById("genDate").textContent =
      `${d.toLocaleDateString("pl-PL",{year:"numeric",month:"2-digit",day:"2-digit"})} ${d.toLocaleTimeString("pl-PL",{hour:"2-digit",minute:"2-digit"})}`;
    renderAll();
  })();
</script>

<!-- Service Worker -->
<script>
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js').then(()=>console.log("SW ok"));
}
</script>
</body>
</html>
